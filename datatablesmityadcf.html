<html>
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="datatables.css">
	<script type="text/javascript" charset="utf8" src="DataTables-1.10.2/media/js/jquery.js"></script>
	<script type="text/javascript" charset="utf8" src="jquery-ui-1.11.1/jquery-ui.js"></script>
	<script type="text/javascript" charset="utf8" src="DataTables-1.10.2/media/js/jquery.dataTables.js"></script>
	<script type="text/javascript" charset="utf8" src="yadcf-0.8.3/jquery.dataTables.yadcf.js"></script>
	<link href="jquery-ui-1.11.1/jquery-ui.css" rel="stylesheet" type="text/css" />
	<!--<link href="yadcf-0.8.3/jquery.dataTables.yadcf.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" charset="utf8" src="Plugins/api/sum().js"></script>
	<script type="text/javascript" charset="utf8" src="Plugins/api/average().js"></script>-->
	
	
	<script src="d3/d3.js" charset="utf-8"></script>
	<script src="http://dimplejs.org/dist/dimple.v2.1.0.min.js"></script> <!-- todo -->

	<link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'>
	<style type="text/css">
		a.toggle-vis {color:lightblue; cursor: pointer; }
		.alignRight {text-align:right;}
		body {font-family: 'Droid Sans', sans-serif; font-size: 10pt;}
		table {font-size: 1em;}
		#chart_empfänger {float:left;}
		#chart_behörde {float:left;}
	</style>
</head>
<body>
<h1 id="titel">Work in progress!</h1>
<!--
http://www.datatables.net/examples/api/regex.html
http://www.datatables.net/examples/api/show_hide.html
http://www.datatables.net/examples/basic_init/state_save.html


-->
<div id="statistics">
	Anzahl der Auswahl: <span id="span_count"></span> |
	Summe der Auswahl: <span id="span_sum"></span> |
	Durchschnittswert der Auswahl: <span id="span_average"></span> |
	Median der Auswahl: <span id="span_median"></span>
</div>

<div id="charts">
<div id="chart_behörde"></div>
<div id="chart_empfänger"></div>
</div>
<div style="clear:both;"></div>

<script>
var table;
var gefiltertedaten;
var selectedrecords;
var chart_behoerde;

$(document).ready(function() {
    table = $('#unsereDataTable').DataTable( {
        "ajax": "jsonfordatatables.php",
        stateSave: true,
        bProcessing: true,
        //"responsive": true,
        //"bPaginate": false,
        "formatNumber": function ( toFormat ) {
    		return toFormat.toString().replace(
    			/\B(?=(\d{3})+(?!\d))/g, "wird leider nicht in der tabelle verwendet, nur im footer?!"
    		);
    	},
    	"language": {
    		"thousands": "geht garnicht"
    	},
        "columns": [
            { "data": "inez", "visible": false },
            { "data": "empfaenger" },
            { "data": "behoerde" },
            { "data": "jahr" },
            { "data": "einzelplan" },
            { "data": "einzelplan_stern" },
            { "data": "aob", "visible": false },
            { "data": "kapitel", "visible": false },
            { "data": "titel", "visible": false },
            { "data": "zweckbestimmung" },
            { "data": "haushaltstyp", "visible": false },
            { "data": "zuwendung" },
            { "data": "foerderungsart", "visible": false },
            { "data": "gesamtzuwendung", sClass: "alignRight gesamtzuwendung" }
        ]
    } );
    
    yadcf.init(table, [{
        column_number: 0,
        filter_type: "text"
    }, {
        column_number: 1,
        filter_type: "auto_complete"
    }, {
        column_number: 2
    }, {
        column_number: 3
    }, {
        column_number: 4,
    }, {
        column_number: 5,
    }, {
        column_number: 6,
    }, {
        column_number: 7,
        filter_type: "text"
    }, {
        column_number: 8,
        filter_type: "text"
    }, {
        column_number: 9,
        filter_type: "text"
    }, {
        column_number: 10,
        filter_type: "text"
    }, {
        column_number: 11,
        filter_type: "text"
    }, {
        column_number: 12,
    }, {
        column_number: 13,
        filter_type: "none"
    }]);
    
    $('a.toggle-vis').on( 'click', function (e) {
		e.preventDefault();
		var column = table.column( $(this).attr('data-column') );
		column.visible( ! column.visible() );
    } );
    
    $('#unsereDataTable').on('draw.dt', function() {
    	// wird gefeuert wenn die tabelle fertig gerendert wurde
    	//console.log("draw.dt");
    	
    	//$("#titel").text($("#unsereDataTable").DataTable().column(".gesamtzuwendung").data().sum());
    	
    	
    	selectedrecords = $("#unsereDataTable").dataTable()._('tr', {"filter": "applied"});
    	updateStatistics();
    });
    
    var svg_behoerde = dimple.newSvg("#chart_behörde", 250, 400);
    chart_behoerde = new dimple.chart(svg_behoerde);
    chart_behoerde.setBounds(20, 20, 200, 200)
    chart_behoerde.addMeasureAxis("p", "gesamtzuwendung");
    series_behoerde = chart_behoerde.addSeries("behoerde", dimple.plot.pie);
    chart_behoerde.addLegend(20, 210, 0, 100, "left");
    
    var svg_empfaenger = dimple.newSvg("#chart_empfänger", 700, 400);
    chart_empfaenger = new dimple.chart(svg_empfaenger);
    chart_empfaenger.setBounds(20, 20, 300, 300)
    chart_empfaenger.addMeasureAxis("p", "gesamtzuwendung");
    series_empfaenger = chart_empfaenger.addSeries("empfaenger", dimple.plot.pie);
    chart_empfaenger.addLegend(180, 20, 90, 150, "left");
    
    updateStatistics();
} );

function updateStatistics() {
	var count = $("#unsereDataTable").dataTable()._('tr', {"filter": "applied"}).length;
	$('#span_count').text(count); 
	
	//var selectedrecords = $("#unsereDataTable").dataTable()._('tr', {"filter": "applied"});
	
	var sum = 0;
	// sind so ziemlich gleichschnell, also lieber ohne jquery...
	//$.each(selectedrecords, function(index, value) {
	//	sum += parseFloat(value.gesamtzuwendung);
	//});
	for (var i = 0; i < count; i++) {
		sum += parseFloat(selectedrecords[i].gesamtzuwendung);
	}
	sum = sum.toFixed(2);
	$('#span_sum').text(sum);
	
	var average = (sum/count).toFixed(2);
	$('#span_average').text(average);
	
	var median = parseFloat(selectedrecords[Math.round(count/2)].gesamtzuwendung).toFixed(2);
	$('#span_median').text(median);
	
	// warum auch immer selectedrecords "circular" sein soll... hiermit mache ich einen normalen array draus
	dimpledata = [];
	for (var i = 0; i < count; i++) {
		dimpledata.push(selectedrecords[i]);
	}
	
	// ich habe einmal den fehler gemacht, eine piechart aller empfaenger zu machen (bzw chromium zu crashen)
	if (count < 100) {
		series_empfaenger.data = dimpledata;
	} else {
		series_empfaenger.data = '';
		console.log("mehr als 100 datensätze, keine empfaenger chart");
	}
	chart_empfaenger.draw();
	
	series_behoerde.data = dimpledata;
	chart_behoerde.draw();
}
</script>

<div>
	Spalten an-/ausschalten: 
	<a class="toggle-vis" data-column="0">INEZ</a>
	<a class="toggle-vis" data-column="1">Empfänger</a>
	<a class="toggle-vis" data-column="2">Behörde</a>
	<a class="toggle-vis" data-column="3">Jahr</a>
	<a class="toggle-vis" data-column="4">Einzelplan</a>
	<a class="toggle-vis" data-column="5">Einzelplan Sternchen</a>
	<a class="toggle-vis" data-column="6">AOB</a>
	<a class="toggle-vis" data-column="7">Kapitel</a>
	<a class="toggle-vis" data-column="8">Titel</a>
	<a class="toggle-vis" data-column="9">Zweckbestimmung</a>
	<a class="toggle-vis" data-column="10">Haushaltstyp</a>
	<a class="toggle-vis" data-column="11">Zuwendung</a>
	<a class="toggle-vis" data-column="12">Förderungsart</a>
	<a class="toggle-vis" data-column="13">Gesamtzuwendung</a>
</div>

<table id="unsereDataTable" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
				<th>INEZ</th>
				<th>Empfänger</th>
				<th>Behörde</th>
				<th>Jahr</th>
				<th>Einzelplan</th>
				<th>Einzelplan Sternchen</th>
				<th>AOB</th>
				<th>Kapitel</th>
				<th>Titel</th>
				<th>Zweckbestimmung</th>
				<th>Haushaltstyp</th>
				<th>Zuwendung</th>
				<th>Förderungsart</th>
				<th>Gesamtzuwendung</th>
            </tr>
        </thead>
 
        <tfoot>
            <tr>
				<th>INEZ</th>
				<th>Empfänger</th>
				<th>Behörde</th>
				<th>Jahr</th>
				<th>Einzelplan</th>
				<th>Einzelplan Sternchen</th>
				<th>AOB</th>
				<th>Kapitel</th>
				<th>Titel</th>
				<th>Zweckbestimmung</th>
				<th>Haushaltstyp</th>
				<th>Zuwendung</th>
				<th>Förderungsart</th>
				<th>Gesamtzuwendung</th>
            </tr>
        </tfoot>
    </table>
<p>Datenbasis sind primär von Freie und Hansestadt Hamburg, Finanzbehörde, [2014]:
<ul>
<li><a href="http://suche.transparenz.hamburg.de/dataset/zuwendungsbericht-hamburg-2011">http://suche.transparenz.hamburg.de/dataset/zuwendungsbericht-hamburg-2011</a></li>
<li><a href="http://suche.transparenz.hamburg.de/dataset/zuwendungsbericht-hamburg-2013">http://suche.transparenz.hamburg.de/dataset/zuwendungsbericht-hamburg-2013</a></li>
</ul>
sowie die jeweiligen Einzelpläne für mehr Details. Ein Archiv der Daten sowie den nicht wirklich aktuellen Code gibt es auf Github: <a href="https://github.com/kannes/hh_zuwendungen">https://github.com/kannes/hh_zuwendungen</a></p>
</body>
</html>
